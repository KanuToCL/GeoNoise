<!doctype html>
<html lang="en" data-theme="default">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoNoise</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./styles/theme.css" />
    <link rel="stylesheet" href="./style.css" />
    <script type="importmap">
      {
        "imports": {
          "@geonoise/shared": "/packages/shared/dist/index.js",
          "@geonoise/core": "/packages/core/dist/index.js",
          "@geonoise/core/coords": "/packages/core/dist/coords/index.js",
          "@geonoise/geo": "/packages/geo/dist/index.js",
          "@geonoise/engine": "/packages/engine/dist/index.js",
          "@geonoise/engine-backends": "/packages/engine-backends/dist/index.js",
          "@geonoise/engine-webgpu": "/packages/engine-webgpu/dist/index.js",
          "zod": "https://esm.sh/zod@3.22.4"
        }
      }
    </script>
  </head>
  <body>
    <div class="app-shell">
      <!-- Fullscreen map canvas layer. -->
      <div class="canvas-frame">
        <canvas id="mapCanvas"></canvas>
        <div class="canvas-status">
          <div class="scale-bar">
            <div class="scale-line" id="scaleLine"></div>
            <div class="scale-text" id="scaleText">100 m</div>
          </div>
          <div class="canvas-status-line" aria-live="polite">
            <span class="canvas-status-item">x: <span id="debug-x">0.0</span>m y: <span id="debug-y">0.0</span>m</span>
            <span class="canvas-status-sep">|</span>
            <span class="canvas-status-item">Units: Meters</span>
            <span class="canvas-status-sep">|</span>
            <span class="canvas-status-item">Mode: <span id="debug-mode">Select</span></span>
            <span class="canvas-status-sep">|</span>
            <button
              class="status-refine-button"
              id="refineButton"
              type="button"
              title="Force high-quality refine"
              aria-label="Force high-quality refine"
            >
              <span class="status-refine-icon" aria-hidden="true">‚ü≥</span>
              <span>Refine</span>
            </button>
          </div>
        </div>
        <div class="snap-indicator" id="snapIndicator"></div>
        <div class="canvas-corner">
          <div class="db-legend" id="dbLegend" role="group" aria-label="Decibel legend">
            <div class="db-legend-bar">
              <div class="db-legend-gradient" id="dbLegendGradient" aria-hidden="true"></div>
              <div class="db-legend-labels" id="dbLegendLabels">
                <span>30 dB</span>
                <span>85 dB</span>
              </div>
            </div>
          </div>
          <div class="canvas-help" id="canvasHelp">
            <button
              class="ghost ui-button canvas-help-button"
              id="canvasHelpButton"
              type="button"
              aria-expanded="false"
              aria-label="Canvas help"
            >
              ?
            </button>
            <div class="canvas-help-tooltip" id="canvasHelpTooltip" role="tooltip">
              <div class="canvas-help-title">Canvas controls</div>
              <div class="canvas-help-body">Drag: pan ‚Ä¢ Scroll: zoom ‚Ä¢ Click: select ‚Ä¢ Shift+Drag: duplicate</div>
              <button class="ghost ui-button canvas-help-dismiss" id="canvasHelpDismiss" type="button">Got it</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Floating UI overlay (non-blocking except for interactive elements). -->
      <div class="ui-layer">
        <header class="topbar topbar-floating">
          <div class="topbar-left">
            <div class="topbar-actions">
              <button class="ghost ui-button" id="undoButton" type="button" title="Undo the last change.">Undo</button>
              <button class="ghost ui-button" id="redoButton" type="button" title="Redo the last change.">Redo</button>
            </div>
          </div>
          <div class="topbar-center">
            <div class="brand brand--debossed">
              <div class="brand-icon" aria-hidden="true">
                <span class="brand-ring ring-1"></span>
                <span class="brand-ring ring-2"></span>
                <span class="brand-ring ring-3"></span>
                <span class="brand-core"></span>
              </div>
              <div class="brand-title">geonoise</div>
            </div>
          </div>
          <div class="topbar-right">
            <div class="control-module">
              <div class="run-group">
                <button
                  class="primary ui-button"
                  id="computeButton"
                  type="button"
                  title="Run propagation and update receiver/grid levels."
                >
                  Compute
                </button>
                <!-- Whole-scene noise map ("Mesh All"): compute a padded grid and render as a heatmap overlay. -->
                <button class="primary ui-button" id="meshButton" type="button" title="Generate a whole-scene noise map.">
                  Generate Map
                </button>
                <div class="status-chip status-chip--small" id="computeChip" aria-label="Compute status">Ready</div>
              </div>
              <div class="run-options is-hidden" aria-hidden="true">
                <label for="computePreference">CPU</label>
                <div class="select-shell">
                  <select class="ui-inset" id="computePreference">
                    <option value="cpu">CPU</option>
                  </select>
                </div>
              </div>
              <!-- Lightweight feedback for heavy map computation (keeps UI responsive). -->
              <div class="map-toast" id="mapToast" role="status" aria-live="polite"></div>
            </div>
            <div class="layers-toggle" id="layersToggle">
              <button class="ghost ui-button" id="layersButton" type="button" aria-expanded="false">
                Layers
              </button>
            </div>
            <button class="ghost ui-button" id="aboutButton" type="button" title="Model notes, assumptions, and limitations.">
              About
            </button>
          </div>
        </header>

        <!-- Layers popover (outside topbar to escape stacking context) -->
        <div class="layers-popover" id="layersPopover" aria-hidden="true">
          <div class="layers-section">
            <div class="layers-title">Layers</div>
            <label class="toggle">
              <input type="checkbox" id="layerSources" checked />
              <span>Sources</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerReceivers" checked />
              <span>Receivers</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerPanels" checked />
              <span>Measure Grids</span>
            </label>
            <!-- Heatmap layer produced by Generate Map. -->
            <label class="toggle">
              <input type="checkbox" id="layerNoiseMap" />
              <span>Noise Map</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerGrid" />
              <span>Grid Overlay</span>
            </label>
          </div>
          <div class="layers-divider"></div>
          <div class="layers-section">
            <div class="layers-title">Display Settings</div>
            <label class="property-row property-row-stack">
              <span>Frequency Weighting</span>
              <select class="ui-inset" id="displayWeighting">
                <option value="A" selected>A-weighting (dBA)</option>
                <option value="C">C-weighting (dBC)</option>
                <option value="Z">Z-weighting (dBZ / Linear)</option>
              </select>
            </label>
            <label class="property-row property-row-stack">
              <span>Display Band</span>
              <select class="ui-inset" id="displayBand">
                <option value="overall" selected>Overall (Sum)</option>
                <option value="0">63 Hz</option>
                <option value="1">125 Hz</option>
                <option value="2">250 Hz</option>
                <option value="3">500 Hz</option>
                <option value="4">1000 Hz</option>
                <option value="5">2000 Hz</option>
                <option value="6">4000 Hz</option>
                <option value="7">8000 Hz</option>
                <option value="8">16000 Hz</option>
              </select>
            </label>
          </div>
          <div class="layers-divider"></div>
          <div class="layers-section">
            <div class="layers-title">Map Settings</div>
            <label class="toggle">
              <input type="checkbox" id="mapRenderStyle" />
              <span>Render mode: Smooth / Contours</span>
            </label>
            <div class="property-row map-band-step" id="mapBandStepRow">
              <span>Band Step (dB)</span>
              <input class="ui-inset" id="mapBandStep" type="number" min="1" max="20" step="1" value="3" />
            </div>
            <label class="toggle">
              <input type="checkbox" id="mapAutoScale" checked />
              <span>Auto-scale colors</span>
            </label>
          </div>
        </div>

        <!-- Bottom dock for creation tools. -->
        <div class="dock">
          <div class="dock-stack">
            <div class="dock-label-stage" id="dockLabelStage" aria-hidden="true">
              <span id="dockLabelText"></span>
            </div>
            <div class="dock-tools" id="toolGrid">
              <button
                class="dock-button ui-button is-active"
                data-tool="select"
                data-label="Select Tool (V)"
                type="button"
                aria-label="Select (V)"
              >
                <span class="dock-label">V</span>
              </button>
              <button
                class="dock-button ui-button"
                data-tool="add-source"
                data-label="Add Source (S)"
                type="button"
                aria-label="Add Source (S)"
              >
                <span class="dock-label">S</span>
              </button>
              <button
                class="dock-button ui-button"
                data-tool="add-receiver"
                data-label="Add Receiver (R)"
                type="button"
                aria-label="Add Receiver (R)"
              >
                <span class="dock-label">R</span>
              </button>
              <button
                class="dock-button ui-button"
                data-tool="add-probe"
                data-label="Add Probe (P)"
                type="button"
                aria-label="Add Probe (P)"
              >
                <svg class="dock-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M12 3a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V6a3 3 0 0 0-3-3z"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M5 11a7 7 0 0 0 14 0M12 18v3M8 21h8"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <button
                class="dock-button ui-button"
                data-tool="add-barrier"
                data-label="Add Barrier (B)"
                type="button"
                aria-label="Add Barrier (B)"
              >
                <span class="dock-label">B</span>
              </button>
              <button
                class="dock-button ui-button"
                data-tool="add-building"
                data-label="Add Building (H)"
                type="button"
                aria-label="Add Building (H)"
              >
                <span class="dock-label">H</span>
              </button>
              <button
                class="dock-button ui-button"
                data-tool="add-panel"
                data-label="Add Measure Grid (G)"
                type="button"
                aria-label="Add Measure Grid (G)"
              >
                <span class="dock-label">G</span>
              </button>
            </div>
          </div>
          <div class="dock-instruction-bottom">Click to select. Drag to move. Shift+drag to duplicate.</div>
        </div>
        <!-- Settings shortcut uses inline styles to bypass cached/overridden CSS. -->
        <div
          class="settings-footer"
          style="
            position: absolute !important;
            bottom: 160px !important;
            left: 20px !important;
            top: auto !important;
            right: auto !important;
            z-index: 9999 !important;
            display: flex !important;
            flex-direction: column !important;
          "
        >
          <div class="settings-toggle settings-toggle--footer" style="position: relative;">
            <!-- Floating gear button styled to match the light UI pills. -->
            <button
              class="ghost ui-button icon-button"
              id="settingsButton"
              type="button"
              aria-expanded="false"
              aria-controls="settingsPopover"
              aria-label="Simulation physics"
              title="Simulation physics settings"
              style="
                width: 54px !important;
                height: 54px !important;
                border-radius: 50% !important;
                background: rgba(248, 250, 252, 0.95) !important;
                border: 1px solid rgba(148, 163, 184, 0.45) !important;
                color: #475569 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                box-shadow: 0 10px 22px rgba(15, 23, 42, 0.18) !important;
              "
            >
              <span aria-hidden="true" style="font-size: 30px;">‚öô</span>
            </button>

            <!-- Popover uses a darker glass panel for contrast against the canvas. -->
            <div
              class="settings-popover"
              id="settingsPopover"
              aria-hidden="true"
              style="
                position: absolute !important;
                bottom: 100% !important;
                left: 0 !important;
                top: auto !important;
                margin-bottom: 12px !important;
                background: linear-gradient(180deg, rgba(15, 24, 40, 0.98), rgba(10, 18, 31, 0.98)) !important;
                border: 1px solid rgba(148, 163, 184, 0.25) !important;
                border-radius: 18px !important;
                padding: 18px !important;
                width: 280px !important;
                backdrop-filter: blur(16px);
                box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45) !important;
              "
            >
              <div
                class="settings-title"
                style="
                  color: #a5b4c7;
                  font-size: 11px;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.18em;
                  margin-bottom: 14px;
                "
              >
                Simulation Physics
              </div>
              <div class="settings-section">
                <label class="property-row property-row-stack" style="display: block; margin-bottom: 12px;">
                  <span
                    style="
                      display: block;
                      font-size: 12px;
                      color: #e2e8f0;
                      margin-bottom: 6px;
                      letter-spacing: 0.02em;
                    "
                  >
                    Atmospheric Model
                  </span>
                  <select
                    class="ui-inset"
                    id="propagationAbsorption"
                    style="
                      width: 100%;
                      padding: 8px 10px;
                      background: linear-gradient(180deg, #0b1423, #0a1220);
                      color: #f8fafc;
                      border: 1px solid rgba(148, 163, 184, 0.35);
                      border-radius: 10px;
                      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.7), 0 4px 10px rgba(15, 23, 42, 0.35);
                      font-weight: 600;
                    "
                  >
                    <option value="iso9613">ISO 9613-1</option>
                    <option value="simple">Simple</option>
                  </select>
                </label>

                <label
                  class="toggle"
                  for="propagationGroundReflection"
                  style="color: #e2e8f0; font-size: 13px;"
                >
                  <input type="checkbox" id="propagationGroundReflection" />
                  <span>Ground Reflection</span>
                </label>

                <label class="property-row property-row-stack" style="display: block; margin-bottom: 12px;">
                  <span
                    style="
                      display: block;
                      font-size: 12px;
                      color: #e2e8f0;
                      margin-bottom: 6px;
                      letter-spacing: 0.02em;
                    "
                  >
                    Ground Type
                  </span>
                  <select
                    class="ui-inset"
                    id="propagationGroundType"
                    style="
                      width: 100%;
                      padding: 8px 10px;
                      background: linear-gradient(180deg, #0b1423, #0a1220);
                      color: #f8fafc;
                      border: 1px solid rgba(148, 163, 184, 0.35);
                      border-radius: 10px;
                      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.7), 0 4px 10px rgba(15, 23, 42, 0.35);
                      font-weight: 600;
                    "
                  >
                    <option value="hard">Hard (Asphalt, Concrete)</option>
                    <option value="mixed" selected>Mixed</option>
                    <option value="soft">Soft (Grass, Soil)</option>
                  </select>
                </label>

                <label class="property-row property-row-stack" style="display: block; margin-bottom: 12px;">
                  <span
                    style="
                      display: block;
                      font-size: 12px;
                      color: #e2e8f0;
                      margin-bottom: 6px;
                      letter-spacing: 0.02em;
                    "
                  >
                    Ground Algorithm
                  </span>
                  <select
                    class="ui-inset"
                    id="propagationGroundModel"
                    style="
                      width: 100%;
                      padding: 8px 10px;
                      background: linear-gradient(180deg, #0b1423, #0a1220);
                      color: #f8fafc;
                      border: 1px solid rgba(148, 163, 184, 0.35);
                      border-radius: 10px;
                      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.7), 0 4px 10px rgba(15, 23, 42, 0.35);
                      font-weight: 600;
                    "
                  >
                    <option value="twoRayPhasor">Two-Ray</option>
                    <option value="legacy">ISO 9613-2</option>
                  </select>
                </label>

                <label class="property-row property-row-stack" style="display: block;">
                  <span
                    style="
                      display: block;
                      font-size: 12px;
                      color: #e2e8f0;
                      margin-bottom: 6px;
                      letter-spacing: 0.02em;
                    "
                  >
                    Spreading Loss
                  </span>
                  <select
                    class="ui-inset"
                    id="propagationSpreading"
                    style="
                      width: 100%;
                      padding: 8px 10px;
                      background: linear-gradient(180deg, #0b1423, #0a1220);
                      color: #f8fafc;
                      border: 1px solid rgba(148, 163, 184, 0.35);
                      border-radius: 10px;
                      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.7), 0 4px 10px rgba(15, 23, 42, 0.35);
                      font-weight: 600;
                    "
                  >
                    <option value="spherical">Spherical</option>
                    <option value="cylindrical">Cylindrical</option>
                  </select>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Contextual inspector shown only when a selection exists. -->
        <aside class="context-panel" id="contextPanel" aria-hidden="true">
          <div class="context-header" id="contextHeader">
            <div class="context-title">Inspector</div>
            <button class="context-close ui-button" id="contextClose" type="button" aria-label="Close inspector">√ó</button>
          </div>
          <div class="inspector-body">
            <div class="inspector-row">
              <span>Selected</span>
              <strong id="selectionLabel">None</strong>
            </div>
            <div class="inspector-row">
              <span>Mode</span>
              <strong id="modeLabel">Select</strong>
            </div>
            <div class="inspector-row">
              <span>Snap</span>
              <strong>5 m</strong>
            </div>
            <div class="inspector-hint" id="selectionHint">Click an item to edit it.</div>
          </div>
          <div class="context-section">
            <div class="context-section-title">Properties</div>
            <div class="properties" id="propertiesBody">Select an item to edit its properties.</div>
          </div>
          <div class="context-section" id="panelStatsSection">
            <div class="context-section-title">Measure Grid Stats</div>
            <div class="panel-legend" id="panelLegend"></div>
            <div class="panel-stats" id="panelStats"></div>
          </div>
        </aside>

        <aside class="probe-panel" id="probePanel" aria-hidden="true">
          <div class="probe-header">
            <div class="probe-title" id="probeTitle">Probe</div>
            <div class="probe-actions">
              <button
                class="probe-freeze ui-button"
                id="probeFreeze"
                type="button"
                aria-label="Freeze probe snapshot"
                title="Freeze probe snapshot"
              >
                ‚ùÑ
              </button>
              <button
                class="probe-pin ui-button"
                id="probePin"
                type="button"
                aria-label="Pin monitoring window"
                aria-pressed="false"
                title="Pin monitoring window"
              >
                üìå
              </button>
              <button class="probe-close ui-button" id="probeClose" type="button" aria-label="Close probe inspector">
                x
              </button>
            </div>
          </div>
          <div class="probe-meta">
            <span>Frequency Response</span>
            <span class="probe-status" id="probeStatus">Idle</span>
          </div>
          <div class="probe-chart">
            <canvas id="probeChart"></canvas>
          </div>
          <div class="probe-footer">
            <span>Frequency (Hz)</span>
            <span>Amplitude (dB)</span>
          </div>
        </aside>
      </div>
    </div>

    <div class="modal" id="aboutModal" aria-hidden="true">
      <div class="modal-backdrop" data-modal-close></div>
      <div class="modal-card modal-plate" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
        <div class="modal-header">
          <div class="modal-title">
            <h2 id="aboutTitle">Details</h2>
            <p class="modal-subtitle">Real-time outdoor acoustic simulation</p>
          </div>
          <button class="modal-close ui-button" id="aboutClose" type="button" aria-label="Close">X</button>
        </div>
        <div class="about-tabs" role="tablist" aria-label="About tabs">
          <button
            class="about-tab is-active"
            type="button"
            role="tab"
            id="aboutTabCurrent"
            aria-selected="true"
            aria-controls="aboutPanelCurrent"
            data-about-tab="current"
          >
            Current
          </button>
          <button
            class="about-tab"
            type="button"
            role="tab"
            id="aboutTabEquations"
            aria-selected="false"
            aria-controls="aboutPanelEquations"
            data-about-tab="equations"
          >
            Full Equations
          </button>
        </div>
        <div
          class="about-panel is-active"
          role="tabpanel"
          id="aboutPanelCurrent"
          aria-labelledby="aboutTabCurrent"
          aria-hidden="false"
          data-about-panel="current"
        >
          <div class="spec-grid">
            <div class="spec-section spec-section--full">
              <div class="spec-heading">GOVERNING PHYSICS</div>
              <div class="spec-tray">
                <p class="spec-text">
                  The sound pressure level (L<sub>p</sub>) is calculated by subtracting cumulative attenuation factors
                  from the source sound power level (L<sub>W</sub>).
                </p>
                <div class="equation-pill">
                  L<sub>p</sub> = L<sub>W</sub> - A<sub>div</sub> - A<sub>atm</sub> - A<sub>gr</sub> - A<sub>bar</sub>
                </div>
              </div>
            </div>
            <div class="spec-section">
              <div class="spec-heading">ATTENUATION COMPONENTS</div>
              <div class="spec-tray">
                <div class="spec-subhead">Geometric divergence (A<sub>div</sub>)</div>
                <div class="spec-text">Standard spherical spreading for point sources.</div>
                <div class="equation-pill">A<sub>div</sub> = 20 log<sub>10</sub>(d) + 11</div>
                <div class="spec-subhead">Atmospheric absorption (A<sub>atm</sub>)</div>
                <div class="spec-text">
                  A<sub>atm</sub> = &#945; d / 1000. The coefficient &#945; is computed analytically per ISO 9613-1,
                  summing classical losses with molecular relaxation of nitrogen and oxygen.
                </div>
                <div class="equation-pill">
                  &#945; = &#945;<sub>cl</sub> + (b<sub>N</sub> &#183; f<sup>2</sup>) / (f<sub>r,N</sub> + f<sup>2</sup> /
                  f<sub>r,N</sub>) + (b<sub>O</sub> &#183; f<sup>2</sup>) / (f<sub>r,O</sub> + f<sup>2</sup> / f<sub>r,O</sub>)
                </div>
                <div class="spec-text">&#945;<sub>cl</sub>: Classical viscothermal losses.</div>
                <div class="spec-text">
                  f<sub>r,N</sub>, f<sub>r,O</sub>: Relaxation frequencies for N<sub>2</sub> and O<sub>2</sub>,
                  derived dynamically from molar water vapor concentration (h), temperature, and pressure.
                </div>
                <div class="spec-subhead">Ground effects (A<sub>gr</sub>)</div>
                <div class="spec-text">
                  The engine supports two interaction modes:
                </div>
                <div class="spec-text">
                  Precision (Two-Ray Phasor): sums direct and reflected paths as complex phasors using Delany-Bazley
                  impedance to capture interference (comb filtering).
                </div>
                <div class="equation-pill">
                  p<sub>tot</sub> = e<sup>-jkr<sub>1</sub></sup> / r<sub>1</sub> + Q e<sup>-jkr<sub>2</sub></sup> / r<sub>2</sub>
                </div>
                <div class="spec-text">
                  Where Q is the spherical reflection coefficient and k is the wavenumber.
                </div>
                <div class="spec-text">
                  Legacy (ISO 9613-2): implements the Alternative Method (Eq. 10) for porous ground. Attenuation is
                  calculated using mean path height h<sub>m</sub>.
                </div>
                <div class="equation-pill">
                  A<sub>gr</sub> = 4.8 - (2h<sub>m</sub> / d) (17 + 300 / d) &ge; 0 dB
                </div>
                <div class="spec-subhead">Barrier diffraction (A<sub>bar</sub>)</div>
                <div class="spec-text">
                  The engine implements a 2.5D convex-hull path method to handle both thin walls and
                  finite-thickness buildings.
                </div>
                <div class="spec-text">
                  Path logic: attenuation is determined by the path difference (&delta;) between the direct
                  line-of-sight and the shortest diffracted path over the obstacle.
                </div>
                <div class="spec-text">Thin barriers: single-edge diffraction (S &rarr; Edge &rarr; R).</div>
                <div class="spec-text">
                  Thick barriers (buildings): double-edge diffraction accounting for roof width.
                </div>
                <div class="equation-pill">
                  &delta; = (d<sub>up</sub> + d<sub>roof</sub> + d<sub>down</sub>) - d<sub>direct</sub>
                </div>
                <div class="spec-text">
                  Calculation: Maekawa-style logarithmic approximation based on the Fresnel number
                  (N = 2&delta; / &lambda;).
                </div>
                <div class="equation-pill">A<sub>bar</sub> &#8776; 10 log<sub>10</sub>(3 + 20N)</div>
              </div>
            </div>
            <div class="spec-section">
              <div class="spec-heading">NUMERICAL STABILITY &amp; CONSTRAINTS</div>
              <div class="spec-tray">
                <div class="spec-subhead">Algorithmic guards (QA)</div>
                <ul class="spec-list">
                  <li>Two-ray asymptotes: for |w| &ge; 4, F(w) uses a plane-wave approximation.</li>
                  <li>Angle limits: cos &#952; is clamped to prevent grazing-incidence singularities.</li>
                  <li>Impedance cap: |Z| is capped to avoid runaway reflection coefficients.</li>
                </ul>
                <div class="spec-subhead">Assumptions</div>
                <ul class="spec-list">
                  <li>Broadband: representative center frequency of 1000 Hz.</li>
                  <li>Field: free-field propagation with first-order ground and simple barrier screening.</li>
                  <li>
                    Geometry: 2.5D vertical profile approximation. Terrain is treated as flat (Z=0),
                    while obstacles utilize full height (Z<sub>obs</sub>) and roof geometry for vertical diffraction.
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div
          class="about-panel"
          role="tabpanel"
          id="aboutPanelEquations"
          aria-labelledby="aboutTabEquations"
          aria-hidden="true"
          data-about-panel="equations"
        >
          <div class="spec-grid equations-grid">
            <div class="spec-section spec-section--full">
              <div class="spec-heading">CORE LEVELS</div>
              <div class="spec-tray">
                <div class="spec-text">Overall level at receiver:</div>
                <div class="equation-pill">
                  L<sub>p</sub> = L<sub>W</sub> - A<sub>div</sub> - A<sub>atm</sub> - A<sub>gr</sub> - A<sub>bar</sub>
                </div>
                <div class="spec-text">Energetic summation of multiple sources:</div>
                <div class="equation-pill">
                  L<sub>sum</sub> = 10 log<sub>10</sub>( &Sigma; 10<sup>L<sub>i</sub>/10</sup> )
                </div>
                <div class="spec-text">Sound power conversions:</div>
                <div class="equation-pill">L<sub>W</sub> = 10 log<sub>10</sub>(P / 10<sup>-12</sup>)</div>
                <div class="equation-pill">P = 10<sup>-12</sup> &#183; 10<sup>L<sub>W</sub>/10</sup></div>
              </div>
            </div>
            <div class="spec-section">
              <div class="spec-heading">GEOMETRY</div>
              <div class="spec-tray">
                <div class="spec-text">Plan distance:</div>
                <div class="equation-pill">d<sub>2D</sub> = &radic;((x<sub>2</sub>-x<sub>1</sub>)<sup>2</sup> + (y<sub>2</sub>-y<sub>1</sub>)<sup>2</sup>)</div>
                <div class="spec-text">3D distance:</div>
                <div class="equation-pill">
                  d<sub>3D</sub> = &radic;((x<sub>2</sub>-x<sub>1</sub>)<sup>2</sup> + (y<sub>2</sub>-y<sub>1</sub>)<sup>2</sup> + (z<sub>2</sub>-z<sub>1</sub>)<sup>2</sup>)
                </div>
                <div class="spec-text">Direct path used for diffraction reference:</div>
                <div class="equation-pill">d<sub>direct</sub> = &radic;(d<sub>2D</sub><sup>2</sup> + (h<sub>s</sub> - h<sub>r</sub>)<sup>2</sup>)</div>
              </div>
            </div>
            <div class="spec-section">
              <div class="spec-heading">SPREADING</div>
              <div class="spec-tray">
                <div class="spec-text">Point source (spherical):</div>
                <div class="equation-pill">A<sub>div</sub> = 20 log<sub>10</sub>(d) + 11</div>
                <div class="spec-text">Line source (cylindrical):</div>
                <div class="equation-pill">A<sub>div</sub> = 10 log<sub>10</sub>(d) + 8</div>
              </div>
            </div>
            <div class="spec-section spec-section--full">
              <div class="spec-heading">ATMOSPHERIC ABSORPTION</div>
              <div class="spec-tray">
                <div class="spec-text">Path loss:</div>
                <div class="equation-pill">A<sub>atm</sub> = &alpha; &#183; d</div>
                <div class="spec-text">Speed of sound and wavelength:</div>
                <div class="equation-pill">c = 331.3 + 0.606 T<sub>C</sub></div>
                <div class="equation-pill">&lambda; = c / f</div>
                <div class="spec-text">ISO 9613-1 absorption coefficient:</div>
                <div class="equation-block">
                  <div>&alpha; = 8.686 f<sup>2</sup> [ (1.84e-11 (p/p<sub>0</sub>)<sup>-1</sup> (T/T<sub>0</sub>)<sup>1/2</sup>)</div>
                  <div>+ (T/T<sub>0</sub>)<sup>-2.5</sup> (0.01275 e<sup>-2239.1/T</sup> (f<sub>r,O</sub>/(f<sub>r,O</sub><sup>2</sup> + f<sup>2</sup>))</div>
                  <div>+ 0.1068 e<sup>-3352/T</sup> (f<sub>r,N</sub>/(f<sub>r,N</sub><sup>2</sup> + f<sup>2</sup>))) ]</div>
                </div>
                <div class="equation-block">
                  <div>C = -6.8346 (T<sub>01</sub>/T)<sup>1.261</sup> + 4.6151</div>
                  <div>p<sub>sat</sub> = p<sub>0</sub> &#183; 10<sup>C</sup>, h = RH &#183; p<sub>sat</sub> / p</div>
                  <div>f<sub>r,O</sub> = (p/p<sub>0</sub>) [24 + 4.04e4 h ((0.02 + h)/(0.391 + h))]</div>
                  <div>f<sub>r,N</sub> = (p/p<sub>0</sub>) (T/T<sub>0</sub>)<sup>-1/2</sup> [9 + 280 h e<sup>-4.17((T/T<sub>0</sub>)<sup>-1/3</sup> - 1)</sup>]</div>
                </div>
              </div>
            </div>
            <div class="spec-section spec-section--full">
              <div class="spec-heading">GROUND EFFECTS</div>
              <div class="spec-tray">
                <div class="spec-text">Legacy ISO 9613-2 Eq. 10 (soft ground):</div>
                <div class="equation-pill">
                  A<sub>gr</sub> = max(0, 4.8 - (2h<sub>m</sub> / d) (17 + 300 / d))
                </div>
                <div class="spec-text">Two-ray phasor geometry:</div>
                <div class="equation-pill">
                  r<sub>1</sub> = &radic;(d<sup>2</sup> + (h<sub>s</sub> - h<sub>r</sub>)<sup>2</sup>),
                  r<sub>2</sub> = &radic;(d<sup>2</sup> + (h<sub>s</sub> + h<sub>r</sub>)<sup>2</sup>)
                </div>
                <div class="spec-text">Normalized impedance (Delany-Bazley):</div>
                <div class="equation-pill">
                  &zeta; = 1 + 9.08 (f/&sigma;)<sup>-0.75</sup> - j 11.9 (f/&sigma;)<sup>-0.73</sup>
                </div>
                <div class="spec-text">Reflection coefficient (locally reacting):</div>
                <div class="equation-pill">
                  &Gamma; = (&zeta; cos&#952; - 1) / (&zeta; cos&#952; + 1)
                </div>
                <div class="spec-text">Two-ray ratio and attenuation:</div>
                <div class="equation-block">
                  <div>ratio = 1 + &Gamma; (r<sub>1</sub>/r<sub>2</sub>) e<sup>-jk(r<sub>2</sub> - r<sub>1</sub>)</sup></div>
                  <div>A<sub>gr</sub> = -20 log<sub>10</sub>(max(|ratio|, 10<sup>-6</sup>))</div>
                </div>
              </div>
            </div>
            <div class="spec-section spec-section--full">
              <div class="spec-heading">BARRIER DIFFRACTION</div>
              <div class="spec-tray">
                <div class="spec-text">Thin barrier (single edge):</div>
                <div class="equation-block">
                  <div>A = &radic;(d(S,I)<sup>2</sup> + (h<sub>b</sub> - h<sub>s</sub>)<sup>2</sup>)</div>
                  <div>B = &radic;(d(I,R)<sup>2</sup> + (h<sub>b</sub> - h<sub>r</sub>)<sup>2</sup>)</div>
                  <div>&delta; = A + B - d<sub>direct</sub></div>
                </div>
                <div class="spec-text">Thick barrier (building roof):</div>
                <div class="equation-block">
                  <div>A = &radic;(d(S,I<sub>in</sub>)<sup>2</sup> + (h<sub>b</sub> - h<sub>s</sub>)<sup>2</sup>)</div>
                  <div>B = d(I<sub>in</sub>, I<sub>out</sub>)</div>
                  <div>C = &radic;(d(I<sub>out</sub>,R)<sup>2</sup> + (h<sub>b</sub> - h<sub>r</sub>)<sup>2</sup>)</div>
                  <div>&delta; = A + B + C - d<sub>direct</sub></div>
                </div>
                <div class="spec-text">Maekawa-style insertion loss:</div>
                <div class="equation-pill">N = 2&delta; / &lambda;</div>
                <div class="equation-pill">A<sub>bar</sub> &#8776; 10 log<sub>10</sub>(3 + 20N)</div>
              </div>
            </div>
            <div class="spec-section">
              <div class="spec-heading">WEIGHTING</div>
              <div class="spec-tray">
                <div class="spec-text">Octave-band weighting:</div>
                <div class="equation-pill">L<sub>A</sub> = L<sub>band</sub> + A(f)</div>
                <div class="equation-pill">L<sub>C</sub> = L<sub>band</sub> + C(f)</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="./main.js"></script>
  </body>
</html>
