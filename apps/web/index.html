<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoNoise</title>
    <link rel="stylesheet" href="./style.css" />
    <script type="importmap">
      {
        "imports": {
          "@geonoise/shared": "/packages/shared/dist/index.js",
          "@geonoise/core": "/packages/core/dist/index.js",
          "@geonoise/core/coords": "/packages/core/dist/coords/index.js",
          "@geonoise/geo": "/packages/geo/dist/index.js",
          "@geonoise/engine": "/packages/engine/dist/index.js",
          "@geonoise/engine-backends": "/packages/engine-backends/dist/index.js",
          "@geonoise/engine-webgpu": "/packages/engine-webgpu/dist/index.js",
          "zod": "/node_modules/zod/index.js"
        }
      }
    </script>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <span class="brand-mark"></span>
          <div>
            <div class="brand-title">GeoNoise</div>
            <div class="brand-sub">Phase 1 Console</div>
          </div>
        </div>
        <div class="status" id="computeStatus">Using CPU</div>
        <div class="preference">
          <label for="computePreference">Compute</label>
          <select id="computePreference">
            <option value="auto">Auto</option>
            <option value="cpu">CPU</option>
            <option value="gpu">GPU</option>
          </select>
        </div>
        <div class="actions">
          <button class="ghost" type="button">Load</button>
          <button class="ghost" type="button">Save</button>
          <button class="ghost" id="aboutButton" type="button">About</button>
          <button class="primary" type="button">Compute</button>
        </div>
      </header>

      <div class="content">
        <aside class="sidebar">
          <section class="panel">
            <h2>Tools</h2>
            <div class="tool-grid" id="toolGrid">
              <button class="tool-button is-active" data-tool="select" type="button">Select</button>
              <button class="tool-button" data-tool="add-source" type="button">Add Source</button>
              <button class="tool-button" data-tool="add-receiver" type="button">Add Receiver</button>
              <button class="tool-button" data-tool="add-panel" type="button">Add Measure Grid</button>
              <button class="tool-button" data-tool="measure" type="button">Measure</button>
              <button class="tool-button" data-tool="delete" type="button">Delete</button>
            </div>
            <div class="tool-note">Click or drag on the canvas in local meters.</div>
          </section>

          <section class="panel">
            <h2>Propagation</h2>
            <div class="properties">
              <div class="property-row property-row-stack">
                <span>Spreading</span>
                <select id="propagationSpreading">
                  <option value="spherical">Spherical</option>
                  <option value="cylindrical">Cylindrical</option>
                </select>
              </div>
              <div class="property-row property-row-stack">
                <span>Atmospheric</span>
                <select id="propagationAbsorption">
                  <option value="none">None</option>
                  <option value="simple">Simple</option>
                  <option value="iso9613">ISO 9613-1</option>
                </select>
              </div>
              <label class="toggle">
                <input type="checkbox" id="propagationGroundReflection" />
                <span>Ground reflection</span>
              </label>
              <div class="property-row property-row-stack">
                <span>Ground model</span>
                <select id="propagationGroundModel">
                  <option value="legacy">Legacy</option>
                  <option value="twoRayPhasor">Two-ray phasor</option>
                </select>
              </div>
              <div class="property-row property-row-stack">
                <span>Ground type</span>
                <select id="propagationGroundType">
                  <option value="hard">Hard</option>
                  <option value="mixed">Mixed</option>
                  <option value="soft">Soft</option>
                </select>
              </div>
              <div class="property-row">
                <span>Max distance (m)</span>
                <input id="propagationMaxDistance" type="number" min="1" step="1" />
              </div>
            </div>
            <div class="tool-note">Ground + absorption affect results today. Barriers + multi-reflections are still TODO.</div>
          </section>

          <section class="panel">
            <h2>Layers</h2>
            <label class="toggle">
              <input type="checkbox" id="layerSources" checked />
              <span>Sources</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerReceivers" checked />
              <span>Receivers</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerPanels" checked />
              <span>Measure Grids</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerGrid" />
              <span>Grid Overlay</span>
            </label>
          </section>

          <section class="panel">
            <h2>Ruler</h2>
            <div class="ruler-card">
              <div class="ruler-label" id="rulerLabel">50 m</div>
              <div class="ruler-line" id="rulerLine"></div>
            </div>
            <div class="ruler-note">Uses local meters ENU.</div>
          </section>

          <section class="panel">
            <h2>Scene</h2>
            <div class="scene-meta">
              <div>Sources: <span id="countSources">2</span></div>
              <div>Receivers: <span id="countReceivers">2</span></div>
              <div>Measure grids: <span id="countPanels">1</span></div>
            </div>
          </section>
        </aside>

        <main class="canvas-shell">
          <div class="canvas-frame">
            <canvas id="mapCanvas"></canvas>
            <div class="canvas-hud">
              <div class="hud-card">
                <div class="hud-title">Pointer</div>
                <div class="hud-value" id="coordLabel">x: 0.0 m, y: 0.0 m</div>
              </div>
              <div class="hud-card">
                <div class="hud-title">Active Layer</div>
                <div class="hud-value" id="layerLabel">Sources</div>
              </div>
            </div>
            <div class="scale-bar">
              <div class="scale-line" id="scaleLine"></div>
              <div class="scale-text" id="scaleText">100 m</div>
            </div>
          </div>
          <div class="canvas-footer">
            <div class="footer-pill">Canvas: Local meters</div>
            <div class="footer-pill" id="statusPill">Ready</div>
          </div>
        </main>

        <aside class="inspector">
          <section class="panel">
            <h2>Inspector</h2>
            <div class="inspector-body">
              <div class="inspector-row">
                <span>Selection</span>
                <strong id="selectionLabel">None</strong>
              </div>
              <div class="inspector-row">
                <span>Mode</span>
                <strong id="modeLabel">Select</strong>
              </div>
              <div class="inspector-row">
                <span>Snap</span>
                <strong>5 m</strong>
              </div>
            </div>
          </section>

          <section class="panel">
            <h2>Properties</h2>
            <div class="properties" id="propertiesBody">Select an item to edit its properties.</div>
          </section>

          <section class="panel">
            <h2>Sources</h2>
            <div class="results-section">
              <div class="results-table" id="sourceTable"></div>
            </div>
          </section>

          <section class="panel">
            <h2>Measure Grid Stats</h2>
            <div class="results-section">
              <div class="panel-legend" id="panelLegend"></div>
              <div class="panel-stats" id="panelStats"></div>
            </div>
          </section>

          <section class="panel">
            <h2>Results</h2>
            <div class="results-section">
              <div class="results-title">Receivers</div>
              <div class="results-table" id="receiverTable"></div>
            </div>
            <button class="ghost" id="exportCsv" type="button">Export CSV</button>
          </section>

          <section class="panel">
            <h2>Notes</h2>
            <p class="note">Drag nodes and measure grids to trigger recompute once wired.</p>
          </section>
        </aside>
      </div>
    </div>

    <div class="modal" id="aboutModal" aria-hidden="true">
      <div class="modal-backdrop" data-modal-close></div>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
        <div class="modal-header">
          <h2 id="aboutTitle">About the Engine</h2>
          <button class="ghost" id="aboutClose" type="button">Close</button>
        </div>
        <p class="note">
          This phase uses a simplified outdoor propagation model intended for fast iteration, not compliance.
        </p>
        <div class="about-grid">
          <div class="about-block">
            <h3>Physics</h3>
            <ul>
              <li>Geometric spreading: Adiv = 20 log10(r) + 11 (spherical) or 10 log10(r) + 8 (cylindrical).</li>
              <li>Atmospheric absorption: Aatm = alpha(f,T,RH,P) * distance, using Simple or ISO 9613-1.</li>
              <li>Broadband uses a representative frequency of 1000 Hz (no per-band propagation yet).</li>
              <li>Ground effect: legacy ISO 9613-2-style correction or optional two-ray phasor model; two-ray can boost or dip levels via interference.</li>
              <li>Legacy ground: ISO 9613-2 Eq. (10) with hm=(hs+hr)/2, dd=max(r1,1), 300/dd term, and negative values clamped to 0; applied only for soft ground; Dn is intentionally omitted.</li>
              <li>Two-ray ground: direct + reflected paths are summed as complex phasors using Delany–Bazley impedance (not Miki) and numerical distance w.</li>
              <li>Two-ray guards: asymptotic F(w) for |w|>=4 with plane-wave fallback for small |w|, cosθ clamp, |Γ| cap, and |R| floor.</li>
              <li>Barrier loss: Maekawa formula is implemented but not wired without barrier geometry.</li>
            </ul>
          </div>
          <div class="about-block">
            <h3>Assumptions</h3>
            <ul>
              <li>Free-field, no buildings or terrain occlusion.</li>
              <li>No scattering, diffraction, or multi-reflections.</li>
              <li>Default mode is fast, not standards-accurate.</li>
            </ul>
          </div>
          <div class="about-block">
            <h3>Method</h3>
            <ul>
              <li>For each source-target: L = Lw - (Adiv + Aatm + Agr + Abar).</li>
              <li>Source summation is energetic: 10 log10(sum 10^(Li/10)).</li>
              <li>Measure grid stats use min/max/avg/L50/L95 of sample points.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="./main.js"></script>
  </body>
</html>
