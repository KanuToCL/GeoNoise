<!doctype html>
<html lang="en" data-theme="default">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoNoise</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./styles/theme.css" />
    <link rel="stylesheet" href="./style.css" />
    <script type="importmap">
      {
        "imports": {
          "@geonoise/shared": "/packages/shared/dist/index.js",
          "@geonoise/core": "/packages/core/dist/index.js",
          "@geonoise/core/coords": "/packages/core/dist/coords/index.js",
          "@geonoise/geo": "/packages/geo/dist/index.js",
          "@geonoise/engine": "/packages/engine/dist/index.js",
          "@geonoise/engine-backends": "/packages/engine-backends/dist/index.js",
          "@geonoise/engine-webgpu": "/packages/engine-webgpu/dist/index.js",
          "zod": "/node_modules/zod/index.js"
        }
      }
    </script>
  </head>
  <body>
    <div class="app">
      <header class="topbar ui-surface">
        <div class="topbar-left">
          <div class="topbar-actions">
            <button class="ghost ui-button" id="undoButton" type="button" title="Undo the last change.">Undo</button>
            <button class="ghost ui-button" id="redoButton" type="button" title="Redo the last change.">Redo</button>
          </div>
        </div>
        <div class="topbar-center">
          <div class="brand brand--debossed">
            <div class="brand-icon" aria-hidden="true">
              <span class="brand-ring ring-1"></span>
              <span class="brand-ring ring-2"></span>
              <span class="brand-ring ring-3"></span>
              <span class="brand-core"></span>
            </div>
            <div class="brand-title">geonoise</div>
          </div>
        </div>
        <div class="topbar-right">
          <div class="control-module">
            <div class="run-group">
              <button
                class="primary ui-button"
                id="computeButton"
                type="button"
                title="Run propagation and update receiver/grid levels."
              >
                Compute
              </button>
              <!-- Whole-scene noise map ("Mesh All"): compute a padded grid and render as a heatmap overlay. -->
              <button class="primary ui-button" id="meshButton" type="button" title="Generate a whole-scene noise map.">
                Generate Map
              </button>
              <div class="status-chip status-chip--small" id="computeChip" aria-label="Compute status">Ready</div>
            </div>
            <div class="run-options">
              <label for="computePreference">CPU</label>
              <div class="select-shell">
                <select class="ui-inset" id="computePreference">
                  <option value="cpu">CPU</option>
                </select>
              </div>
            </div>
            <!-- Lightweight feedback for heavy map computation (keeps UI responsive). -->
            <div class="map-toast" id="mapToast" role="status" aria-live="polite"></div>
          </div>
          <button class="ghost ui-button" id="aboutButton" type="button" title="Model notes, assumptions, and limitations.">
            About
          </button>
        </div>
      </header>

      <div class="content">
        <aside class="sidebar">
          <section class="panel ui-surface">
            <h2>Tools</h2>
            <div class="tool-groups" id="toolGrid">
              <div class="tool-group">
                <div class="tool-group-title">Edit</div>
                <div class="tool-grid">
                  <button class="tool-button ui-button is-active" data-tool="select" type="button">Select (V)</button>
                  <button class="tool-button ui-button" data-tool="delete" type="button">Delete (Del)</button>
                </div>
              </div>
              <div class="tool-group">
                <div class="tool-group-title">Add</div>
                <div class="tool-grid">
                  <button class="tool-button ui-button" data-tool="add-source" type="button">Source (S)</button>
                  <button class="tool-button ui-button" data-tool="add-receiver" type="button">Receiver (R)</button>
                  <button class="tool-button ui-button" data-tool="add-barrier" type="button">Barrier (B)</button>
                  <button class="tool-button ui-button" data-tool="add-building" type="button">Building (H)</button>
                  <button class="tool-button ui-button" data-tool="add-panel" type="button">Measure Grid (G)</button>
                </div>
              </div>
              <div class="tool-group">
                <div class="tool-group-title">Inspect</div>
                <div class="tool-grid">
                  <button class="tool-button ui-button" data-tool="measure" type="button">Measure (M)</button>
                </div>
              </div>
            </div>
            <div class="tool-instruction" id="toolInstruction"></div>
          </section>

          <section class="panel ui-surface">
            <h2>Propagation model</h2>
            <div class="properties">
              <div class="property-row property-row-stack">
                <div class="field-label">
                  <span>Spreading</span>
                  <span class="tooltip">
                    <button class="tooltip-trigger ui-button" type="button" aria-label="Spreading info">?</button>
                    <span class="tooltip-content">
                      <span class="tooltip-note">Distance loss model (point vs line sources).</span>
                    </span>
                  </span>
                </div>
                <select class="ui-inset" id="propagationSpreading">
                  <option value="spherical">Spherical</option>
                  <option value="cylindrical">Cylindrical</option>
                </select>
                <div class="field-help">Controls distance loss.</div>
              </div>
              <div class="property-row property-row-stack">
                <div class="field-label">
                  <span>Atmospheric</span>
                  <span class="tooltip">
                    <button class="tooltip-trigger ui-button" type="button" aria-label="Atmospheric info">?</button>
                    <span class="tooltip-content">
                      <span class="tooltip-note">Air absorption vs frequency.</span>
                    </span>
                  </span>
                </div>
                <select class="ui-inset" id="propagationAbsorption">
                  <option value="none">None</option>
                  <option value="simple">Simple</option>
                  <option value="iso9613">ISO 9613-1</option>
                </select>
                <div class="field-help">Controls air absorption.</div>
              </div>
              <label class="toggle">
                <input type="checkbox" id="propagationGroundReflection" />
                <span>Ground effects</span>
              </label>
              <div class="field-help" id="propagationGroundHelp">Includes reflection + absorption by ground.</div>
              <div class="ground-details" id="propagationGroundDetails">
                <div class="property-row property-row-stack">
                <div class="field-label">
                  <span>Ground model</span>
                  <span class="tooltip">
                    <button class="tooltip-trigger ui-button" type="button" aria-label="Ground model info">?</button>
                    <span class="tooltip-content">
                      <span class="tooltip-title">Direct + reflected paths</span>
                      <pre class="tooltip-diagram">source o----&gt; receiver
      \\      /
       \\____/ ground</pre>
                        <span class="tooltip-note">Detailed mode can raise or lower levels based on phase.</span>
                      </span>
                    </span>
                  </div>
                  <select class="ui-inset" id="propagationGroundModel">
                    <optgroup label="Recommended">
                      <option value="legacy">Simple (ISO 9613-2) - Recommended</option>
                    </optgroup>
                    <optgroup label="Advanced">
                      <option value="twoRayPhasor">Detailed (Two-ray phasor) - Frequency-dependent</option>
                    </optgroup>
                  </select>
                  <div class="field-help" id="propagationGroundModelHelp"></div>
                </div>
                <div class="property-row property-row-stack">
                <div class="field-label">
                  <span>Ground surface</span>
                  <span class="tooltip">
                    <button class="tooltip-trigger ui-button" type="button" aria-label="Ground surface info">?</button>
                    <span class="tooltip-content">
                      <span class="tooltip-note">Porous ground absorbs more; hard ground reflects more.</span>
                    </span>
                  </span>
                </div>
                  <select class="ui-inset" id="propagationGroundType">
                    <option value="hard">Hard (concrete/water)</option>
                    <option value="mixed">Mixed</option>
                    <option value="soft">Porous (grass/soil)</option>
                  </select>
                  <div class="field-help">Porous ground absorbs more; hard ground reflects more.</div>
                </div>
              </div>
              <div class="property-row">
                <span>Max distance (m)</span>
                <input class="ui-inset" id="propagationMaxDistance" type="number" min="1" step="1" />
              </div>
            </div>
            <div class="tool-note">Ground + absorption affect results today. Barriers support simple screen attenuation; multi-reflections are still TODO.</div>
          </section>

          <section class="panel ui-surface">
            <h2>Layers</h2>
            <label class="toggle">
              <input type="checkbox" id="layerSources" checked />
              <span>Sources</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerReceivers" checked />
              <span>Receivers</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerPanels" checked />
              <span>Measure Grids</span>
            </label>
            <!-- Heatmap layer produced by Generate Map. -->
            <label class="toggle">
              <input type="checkbox" id="layerNoiseMap" />
              <span>Noise Map</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="layerGrid" />
              <span>Grid Overlay</span>
            </label>
          </section>

          <section class="panel ui-surface">
            <h2>Ruler</h2>
            <div class="ruler-card">
              <div class="ruler-label" id="rulerLabel">50 m</div>
              <div class="ruler-line" id="rulerLine"></div>
            </div>
            <div class="ruler-note">Uses local meters ENU.</div>
          </section>

          <section class="panel ui-surface">
            <h2>Scene</h2>
            <div class="scene-meta">
              <div>Sources: <span id="countSources">2</span></div>
              <div>Receivers: <span id="countReceivers">2</span></div>
              <div>Measure grids: <span id="countPanels">1</span></div>
            </div>
          </section>
        </aside>

        <main class="canvas-shell">
          <div class="canvas-frame ui-surface">
            <canvas id="mapCanvas"></canvas>
            <div class="canvas-hud">
              <div class="hud-card">
                <div class="hud-title">Pointer</div>
                <div class="hud-value" id="coordLabel">x: 0.0 m, y: 0.0 m</div>
              </div>
              <div class="hud-card">
                <div class="hud-title">Mode</div>
                <div class="hud-value" id="modeHint">Select</div>
              </div>
              <div class="hud-card">
                <div class="hud-title">Active Layer</div>
                <div class="hud-value" id="layerLabel">Sources</div>
              </div>
            </div>
            <div class="canvas-help" id="canvasHelp">
              <button
                class="ghost ui-button canvas-help-button"
                id="canvasHelpButton"
                type="button"
                aria-expanded="false"
                aria-label="Canvas help"
              >
                ?
              </button>
              <div class="canvas-help-tooltip" id="canvasHelpTooltip" role="tooltip">
                <div class="canvas-help-title">Canvas controls</div>
                <div class="canvas-help-body">Drag: pan • Scroll: zoom • Click: select • Shift+Drag: duplicate</div>
                <button class="ghost ui-button canvas-help-dismiss" id="canvasHelpDismiss" type="button">Got it</button>
              </div>
            </div>
            <div class="scale-bar">
              <div class="scale-line" id="scaleLine"></div>
              <div class="scale-text" id="scaleText">100 m</div>
            </div>
            <div class="snap-indicator" id="snapIndicator"></div>
          </div>
          <div class="canvas-footer">
            <div class="footer-pill">Units: meters</div>
          </div>
        </main>

        <aside class="inspector">
          <section class="panel ui-surface">
            <h2>Inspector</h2>
            <div class="inspector-body">
              <div class="inspector-row">
                <span>Selected</span>
                <strong id="selectionLabel">None</strong>
              </div>
              <div class="inspector-row">
                <span>Mode</span>
                <strong id="modeLabel">Select</strong>
              </div>
              <div class="inspector-row">
                <span>Snap</span>
                <strong>5 m</strong>
              </div>
              <div class="inspector-hint" id="selectionHint">Click an item to edit it.</div>
            </div>
          </section>

          <section class="panel ui-surface">
            <h2>Properties</h2>
            <div class="properties" id="propertiesBody">Select an item to edit its properties.</div>
          </section>

          <section class="panel ui-surface">
            <h2>Sources</h2>
            <div class="results-section">
              <div class="results-table" id="sourceTable"></div>
              <div class="field-help" id="sourceSumMode">Summation: Energetic (dB)</div>
            </div>
          </section>

          <section class="panel ui-surface">
            <h2>Measure Grid Stats</h2>
            <div class="results-section">
              <div class="panel-legend" id="panelLegend"></div>
              <div class="panel-stats" id="panelStats"></div>
            </div>
          </section>

          <section class="panel ui-surface">
            <h2>Results</h2>
            <div class="results-section">
              <div class="results-title">Receivers</div>
              <div class="results-table" id="receiverTable"></div>
            </div>
            <button class="ghost ui-button" id="exportCsv" type="button">Export CSV</button>
          </section>

          <section class="panel ui-surface">
            <h2>Notes</h2>
            <p class="note">Drag nodes and measure grids to trigger recompute once wired.</p>
          </section>
        </aside>
      </div>
    </div>

    <div class="modal" id="aboutModal" aria-hidden="true">
      <div class="modal-backdrop" data-modal-close></div>
      <div class="modal-card modal-plate" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
        <div class="modal-header">
          <div class="modal-title">
            <h2 id="aboutTitle">GeoNoise Propagation Engine (Phase 1)</h2>
            <p class="modal-subtitle">Real-time outdoor acoustic simulation</p>
          </div>
          <button class="modal-close ui-button" id="aboutClose" type="button" aria-label="Close">X</button>
        </div>
        <div class="spec-grid">
          <div class="spec-section spec-section--full">
            <div class="spec-heading">GOVERNING PHYSICS</div>
            <div class="spec-tray">
              <p class="spec-text">
                The sound pressure level (L<sub>p</sub>) is calculated by subtracting cumulative attenuation factors
                from the source sound power level (L<sub>W</sub>).
              </p>
              <div class="equation-pill">
                L<sub>p</sub> = L<sub>W</sub> - A<sub>div</sub> - A<sub>atm</sub> - A<sub>gr</sub> - A<sub>bar</sub>
              </div>
            </div>
          </div>
          <div class="spec-section">
            <div class="spec-heading">ATTENUATION COMPONENTS</div>
            <div class="spec-tray">
              <div class="spec-subhead">Geometric divergence (A<sub>div</sub>)</div>
              <div class="spec-text">Standard spherical spreading for point sources.</div>
              <div class="equation-pill">A<sub>div</sub> = 20 log<sub>10</sub>(d) + 11</div>
              <div class="spec-subhead">Atmospheric absorption (A<sub>atm</sub>)</div>
              <div class="spec-text">
                A<sub>atm</sub> = &#945; d / 1000. The coefficient &#945; is computed analytically per ISO 9613-1,
                summing classical losses with molecular relaxation of nitrogen and oxygen.
              </div>
              <div class="equation-pill">
                &#945; = &#945;<sub>cl</sub> + (b<sub>N</sub> &#183; f<sup>2</sup>) / (f<sub>r,N</sub> + f<sup>2</sup> /
                f<sub>r,N</sub>) + (b<sub>O</sub> &#183; f<sup>2</sup>) / (f<sub>r,O</sub> + f<sup>2</sup> / f<sub>r,O</sub>)
              </div>
              <div class="spec-text">&#945;<sub>cl</sub>: Classical viscothermal losses.</div>
              <div class="spec-text">
                f<sub>r,N</sub>, f<sub>r,O</sub>: Relaxation frequencies for N<sub>2</sub> and O<sub>2</sub>,
                derived dynamically from molar water vapor concentration (h), temperature, and pressure.
              </div>
              <div class="spec-subhead">Ground effects (A<sub>gr</sub>)</div>
              <div class="spec-text">
                The engine supports two interaction modes:
              </div>
              <div class="spec-text">
                Precision (Two-Ray Phasor): sums direct and reflected paths as complex phasors using Delany-Bazley
                impedance to capture interference (comb filtering).
              </div>
              <div class="equation-pill">
                p<sub>tot</sub> = e<sup>-jkr<sub>1</sub></sup> / r<sub>1</sub> + Q e<sup>-jkr<sub>2</sub></sup> / r<sub>2</sub>
              </div>
              <div class="spec-text">
                Where Q is the spherical reflection coefficient and k is the wavenumber.
              </div>
              <div class="spec-text">
                Legacy (ISO 9613-2): implements the Alternative Method (Eq. 10) for porous ground. Attenuation is
                calculated using mean path height h<sub>m</sub>.
              </div>
              <div class="equation-pill">
                A<sub>gr</sub> = 4.8 - (2h<sub>m</sub> / d) (17 + 300 / d) &ge; 0 dB
              </div>
              <div class="spec-subhead">Barrier diffraction (A<sub>bar</sub>)</div>
              <div class="spec-text">Maekawa-style approximation based on the Fresnel number (N).</div>
              <div class="equation-pill">A<sub>bar</sub> &#8776; 10 log<sub>10</sub>(3 + 20N)</div>
            </div>
          </div>
          <div class="spec-section">
            <div class="spec-heading">NUMERICAL STABILITY &amp; CONSTRAINTS</div>
            <div class="spec-tray">
              <div class="spec-subhead">Algorithmic guards (QA)</div>
              <ul class="spec-list">
                <li>Two-ray asymptotes: for |w| &ge; 4, F(w) uses a plane-wave approximation.</li>
                <li>Angle limits: cos &#952; is clamped to prevent grazing-incidence singularities.</li>
                <li>Impedance cap: |Z| is capped to avoid runaway reflection coefficients.</li>
              </ul>
              <div class="spec-subhead">Assumptions</div>
              <ul class="spec-list">
                <li>Broadband: representative center frequency of 1000 Hz.</li>
                <li>Field: free-field propagation with first-order ground and simple barrier screening.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="./main.js"></script>
  </body>
</html>
